import requests
import unittest
import json

TASKS_URL: str = "http://127.0.0.1:5000/tasks"
TASK_JSON: dict = {
    'inputs': {
        'args': [1, 2, 3],
        'kwargs': {
            'input_1': 1,
            'input_2': 2
        }
    }
}



class TestTaskAction(unittest.TestCase):

    def test_post_get_put_delete(self):
        # Post
        post_response = requests.post(TASKS_URL, json = TASK_JSON)
        self.assertIn(post_response.status_code, [200,201])
        self.assertIsInstance(post_response.json(), dict)
        id = post_response.json()['id']
        self.assertIsInstance(id, int)

        # Get all:
        get_all_response = requests.get(TASKS_URL)
        self.assertEqual(get_all_response.status_code, 200)
        self.assertIsInstance(get_all_response.json(), dict)
        self.assertIn('tasks', get_all_response.json())
        self.assertIsInstance(get_all_response.json()['tasks'], list)

        # Get task
        task_url = TASKS_URL + '/' + str(id)
        get_response = requests.get(task_url)
        self.assertEqual(get_response.status_code, 200)
        response_task_json = get_response.json()
        response_task_json['inputs'] = json.loads(response_task_json['inputs'])
        self.assertEqual(TASK_JSON, response_task_json)

        # Put task
        new_task_json = {
            'inputs': {
                'args': [4, 5, 6],
                'kwargs': {
                    'input_1': 3,
                    'input_2': 4
                }
            }
        }
        put_response = requests.put(task_url, json = new_task_json)
        self.assertEqual(put_response.status_code, 200)
        self.assertEqual({'message': 'Task updated'}, put_response.json())

        get_response = requests.get(task_url)
        response_task_json = get_response.json()
        response_task_json['inputs'] = json.loads(response_task_json['inputs'])
        self.assertEqual(new_task_json, response_task_json)

        # Delete task
        delete_response = requests.delete(task_url)
        self.assertEqual(delete_response.status_code, 200)
        self.assertEqual({'message': 'Task deleted'}, delete_response.json())

if __name__ == '__main__':
    unittest.main()